<?xml version="1.0" encoding="UTF-8" ?>
<messages>
    <message id="soap.get.dept.structure">
    ВЫБРАТЬ ВзаиморасчетыОстатки.Сделка, ВзаиморасчетыОстатки.СуммаВзаиморасчетовОстаток КАК Сумма, ВзаиморасчетыОстатки.ВалютаДокумента
            ПОМЕСТИТЬ Остатки
            ИЗ
                РегистрНакопления.ВзаиморасчетыСКонтрагентами.Остатки(
                        ДАТАВРЕМЯ({2},{3},{4},0,0,0),
                        Контрагент В
                            (ВЫБРАТЬ
                                Контрагенты.Ссылка
                            ИЗ
                                Справочник.Контрагенты КАК Контрагенты
                            ГДЕ
                                Контрагенты.Код = "{1}")) КАК ВзаиморасчетыОстатки
            ;

            ////////////////////////////////////////////////////////////////////////////////
            ВЫБРАТЬ
                Остатки.Сделка,
                Остатки.Сумма,
                Остатки.ВалютаДокумента,
                РеализацияТоваровУслугСхемаОплаты.Дата КАК ДатаОплаты,
                РАЗНОСТЬДАТ(РеализацияТоваровУслугСхемаОплаты.Дата, ДАТАВРЕМЯ({2},{3},{4},0,0,0), ДЕНЬ) КАК ДнейПросрочено
            ПОМЕСТИТЬ Взаиморасчёты
            ИЗ
                Остатки КАК Остатки
                    ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.СхемаОплаты КАК РеализацияТоваровУслугСхемаОплаты
                    ПО Остатки.Сделка = РеализацияТоваровУслугСхемаОплаты.Ссылка
                        И (РеализацияТоваровУслугСхемаОплаты.Дата В
                            (ВЫБРАТЬ
                                МАКСИМУМ(СхемаОплаты.Дата)
                            ИЗ
                                Документ.РеализацияТоваровУслуг.СхемаОплаты КАК СхемаОплаты
                            ГДЕ
                                РеализацияТоваровУслугСхемаОплаты.Ссылка = СхемаОплаты.Ссылка))
            ;

            ////////////////////////////////////////////////////////////////////////////////
            ВЫБРАТЬ
                РеализацияТоваровУслуг.ИД_Документа,
                Взаиморасчёты.ДатаОплаты,
                ПРЕДСТАВЛЕНИЕ(Взаиморасчёты.Сделка) КАК Сделка,
                ВЫБОР
                    КОГДА ЕСТЬNULL(Взаиморасчёты.ДнейПросрочено, 0) > 0
                        ТОГДА Взаиморасчёты.ДнейПросрочено
                    ИНАЧЕ NULL
                КОНЕЦ КАК ПросроченоДней,
                ВЫБОР
                    КОГДА ЕСТЬNULL(Взаиморасчёты.ДнейПросрочено, 0)
    </message>
</messages>
